<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CSE ELITE | Ultimate Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    /* --- MODERN DARK THEME --- */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #0f172a; color: #cbd5e1; }
    
    /* INTRO ANIMATION SCREEN */
    #intro-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #020617; z-index: 9999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 0.8s ease-out;
    }
    .intro-content { text-align: center; animation: fadeInUp 1s ease-out; }
    .intro-icon { font-size: 80px; color: #fbbf24; margin-bottom: 20px; animation: spin 3s infinite linear; }
    .intro-title { font-size: 40px; font-weight: bold; color: white; letter-spacing: 2px; }
    .intro-sub { color: #94a3b8; font-size: 16px; margin-top: 10px; letter-spacing: 1px; text-transform: uppercase; }
    
    @keyframes spin { 100% { transform: rotate(360deg); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

    /* HEADERS */
    h2 { color: #fbbf24; border-bottom: 2px solid #334155; padding-bottom: 15px; margin-top: 0; display: flex; align-items: center; gap: 10px; }
    
    /* STATS DASHBOARD */
    .stats-container {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 25px;
    }
    .stat-card {
      background: #1e293b; border: 1px solid #334155; padding: 15px; border-radius: 10px;
      display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden;
    }
    .stat-card::after { content: ''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: #3b82f6; }
    .stat-card.total::after { background: #fbbf24; }
    
    .stat-val { font-size: 26px; font-weight: bold; color: #f1f5f9; }
    .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin-top: 5px; }

    /* INPUT & CONTROLS */
    textarea { 
        width: 100%; height: 200px; padding: 15px; font-size: 14px; box-sizing: border-box; 
        border: 1px solid #334155; border-radius: 8px; font-family: "Courier New", monospace; 
        line-height: 1.5; resize: vertical; background: #1e293b; color: #f1f5f9;
    }
    textarea:focus { outline: none; border-color: #fbbf24; box-shadow: 0 0 10px rgba(251, 191, 36, 0.1); }

    .controls { margin: 20px 0; background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155; }
    .controls-row { display:flex; gap:10px; flex-wrap:wrap; align-items: center; }
    
    button { 
        padding: 12px 18px; font-size: 14px; font-weight: 600; cursor: pointer; 
        border: none; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
    }
    button:hover { transform: translateY(-2px); }
    button:active { transform: translateY(0); }

    .btn-gold { background-color: #fbbf24; color: #0f172a; }
    .btn-green { background-color: #10b981; color: white; }
    .btn-red { background-color: #ef4444; color: white; }
    .btn-blue { background-color: #3b82f6; color: white; }
    .btn-dark { background-color: #334155; color: #cbd5e1; }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* STATUS BAR */
    .status-bar { margin-top: 15px; background: #0f172a; padding: 12px; border-radius: 6px; border-left: 4px solid #64748b; font-size: 14px; }
    .status-success { border-color: #10b981; color: #10b981; }
    .status-error { border-color: #ef4444; color: #ef4444; }
    .status-processing { border-color: #fbbf24; color: #fbbf24; }

    /* DATABASE & TABLES */
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-left: 4px solid #3b82f6; padding-left: 10px; }
    .panel-title { font-size: 18px; font-weight: bold; color: #f8fafc; }
    
    .search-box {
        padding: 8px 12px; border-radius: 6px; border: 1px solid #334155; 
        background: #0f172a; color: white; width: 250px;
    }

    .db-list { max-height: 500px; overflow-y: auto; border: 1px solid #334155; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; background: #1e293b; }
    th { background: #0f172a; position: sticky; top: 0; z-index: 10; text-align: left; padding: 12px; border-bottom: 2px solid #334155; color: #94a3b8; font-size: 13px; }
    td { padding: 12px; border-bottom: 1px solid #334155; font-size: 13px; vertical-align: top; color: #cbd5e1; }
    tr:hover { background-color: #2a384a; }

    /* BADGES */
    .badge { padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
    .b-num { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); }
    .b-verb { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
    .b-ana { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
    .b-gen { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
    
    /* PREVIEW CARD */
    .preview-card { background: #1e293b; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #334155; }
    .preview-card.invalid { border-color: #ef4444; background: rgba(239, 68, 68, 0.05); }
    .err-txt { color: #ef4444; font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px; }

  </style>
</head>
<body>

  <div id="intro-screen">
      <div class="intro-content">
          <i class='bx bxs-server intro-icon'></i>
          <div class="intro-title">CSE ELITE</div>
          <div class="intro-sub">Admin Uploader System</div>
          <div style="margin-top: 20px; color: #3b82f6;">Loading Database...</div>
      </div>
  </div>

  <h2><i class='bx bxs-server'></i> CSE ELITE: Ultimate Admin</h2>

  <div class="stats-container">
    <div class="stat-card total"><span class="stat-val" id="s-total">0</span><span class="stat-label">Total</span></div>
    <div class="stat-card"><span class="stat-val" id="s-num">0</span><span class="stat-label">Numerical</span></div>
    <div class="stat-card"><span class="stat-val" id="s-verb">0</span><span class="stat-label">Verbal</span></div>
    <div class="stat-card"><span class="stat-val" id="s-ana">0</span><span class="stat-label">Analytical</span></div>
    <div class="stat-card"><span class="stat-val" id="s-gen">0</span><span class="stat-label">Gen. Info</span></div>
    <div class="stat-card"><span class="stat-val" id="s-cler">0</span><span class="stat-label">Clerical</span></div>
  </div>

  <div style="margin-bottom: 5px; font-size: 13px; color:#94a3b8;">
    <i class='bx bx-info-circle'></i> Paste questions below. The system will automatically remove duplicates before uploading.
  </div>
  <textarea id="bulkRaw" placeholder="Paste your questions here...

1. If 2x + 4 = 10, what is x?
A. 1
B. 2
C. 3
D. 4
Answer: C
Rationale: 2x = 6, so x = 3.
Category: Numerical"></textarea>

  <div class="controls">
    <div class="controls-row">
      <button id="btnScan" class="btn-gold"><i class='bx bx-scan'></i> 1. Scan & Verify</button>
      <button id="btnUpload" class="btn-green" disabled><i class='bx bx-cloud-upload'></i> 2. Upload to Firebase</button>
      <button id="btnClear" class="btn-red"><i class='bx bx-trash'></i> Clear</button>
      <div style="flex-grow:1"></div>
      <button id="btnRefresh" class="btn-blue"><i class='bx bx-refresh'></i> Refresh Data</button>
      <button id="btnExport" class="btn-dark"><i class='bx bx-download'></i> Backup JSON</button>
    </div>
    <div id="status" class="status-bar">System Ready.</div>
  </div>

  <div id="previewSection" style="display:none; margin-top:30px;">
    <div class="panel-header">
      <span class="panel-title">Scanned Items Preview</span>
    </div>
    <div id="previewList"></div>
  </div>

  <div id="dbSection" style="margin-top:30px;">
    <div class="panel-header">
      <span class="panel-title">Live Database (Latest 100)</span>
      <input type="text" id="searchDB" class="search-box" placeholder="Search questions...">
    </div>
    <div class="db-list">
      <table id="dbTable">
        <thead>
          <tr>
            <th width="45%">Question</th>
            <th width="15%">Answer</th>
            <th width="15%">Category</th>
            <th width="15%">Date Uploaded</th> <th width="10%">Action</th>
          </tr>
        </thead>
        <tbody id="dbBody"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, doc, deleteDoc, getDocs, query, orderBy, where, limit 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- YOUR API KEY ---
    const firebaseConfig = {
      apiKey: "AIzaSyBY4msSow0k_2iP0IJeMZH8Qbzdj5lXeAo",
      authDomain: "csereviewer-fef62.firebaseapp.com",
      projectId: "csereviewer-fef62",
      storageBucket: "csereviewer-fef62.firebasestorage.app",
      messagingSenderId: "74512458822",
      appId: "1:74512458822:web:3bdde797fb72930c801647",
      measurementId: "G-D8SESFX8T5"
    };

    // INIT FIREBASE
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- DOM ELEMENTS ---
    const els = {
      raw: document.getElementById("bulkRaw"),
      btnScan: document.getElementById("btnScan"),
      btnUpload: document.getElementById("btnUpload"),
      btnClear: document.getElementById("btnClear"),
      btnRefresh: document.getElementById("btnRefresh"),
      btnExport: document.getElementById("btnExport"),
      status: document.getElementById("status"),
      previewSection: document.getElementById("previewSection"),
      previewList: document.getElementById("previewList"),
      dbBody: document.getElementById("dbBody"),
      searchDB: document.getElementById("searchDB"),
      intro: document.getElementById("intro-screen"),
      // Stats
      sTotal: document.getElementById("s-total"),
      sNum: document.getElementById("s-num"),
      sVerb: document.getElementById("s-verb"),
      sAna: document.getElementById("s-ana"),
      sGen: document.getElementById("s-gen"),
      sCler: document.getElementById("s-cler")
    };

    let parsedItems = [];
    let allDBData = []; // Store for search

    // --- INTRO LOGIC ---
    window.addEventListener("DOMContentLoaded", () => {
        // Remove Intro after 2.5 seconds
        setTimeout(() => {
            els.intro.style.opacity = "0";
            setTimeout(() => {
                els.intro.style.display = "none";
            }, 800); // wait for fade out
        }, 2500);
    });

    // --- HELPER FUNCTIONS ---
    const cleanStr = (s) => (s || "").replace(/\s+/g, " ").trim();
    const escapeHtml = (str) => (!str ? "" : str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]));
    
    // FORMAT DATE FUNCTION
    const formatDate = (timestamp) => {
        if(!timestamp) return "Unknown";
        const d = new Date(timestamp);
        return d.toLocaleString('en-US', { 
            month: 'short', day: 'numeric', year: 'numeric', 
            hour: '2-digit', minute: '2-digit' 
        });
    };

    const setStatus = (msg, type="normal") => {
      els.status.innerHTML = msg;
      els.status.className = "status-bar " + (type === "error" ? "status-error" : type === "success" ? "status-success" : type === "process" ? "status-processing" : "");
    };

    // Fisher-Yates Shuffle
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // --- CATEGORY DETECTION ---
    function detectCategory(text) {
        const t = text.toLowerCase();
        // 1. Explicit
        if(t.includes("category: numerical") || t.includes("topic: numerical")) return "Numerical";
        if(t.includes("category: verbal") || t.includes("topic: verbal")) return "Verbal";
        if(t.includes("category: analytical") || t.includes("topic: analytical")) return "Analytical";
        if(t.includes("category: gen") || t.includes("topic: gen")) return "GenInfo";
        if(t.includes("category: cler") || t.includes("topic: cler")) return "Clerical";

        // 2. Keyword
        if (["math", "solve", "calculate", "number", "fraction", "ratio"].some(w => t.includes(w))) return "Numerical";
        if (["grammar", "sentence", "verb", "synonym", "antonym"].some(w => t.includes(w))) return "Verbal";
        if (["logic", "assumption", "conclusion", "pattern"].some(w => t.includes(w))) return "Analytical";
        if (["constitution", "law", "republic act", "rights"].some(w => t.includes(w))) return "GenInfo";
        if (["filing", "alphabetical", "clerical"].some(w => t.includes(w))) return "Clerical";
        
        return "General";
    }

    // --- PARSER ---
    function parseText(rawText) {
      const blocks = rawText.split(/\n\s*\n|---/).map(b => b.trim()).filter(b => b.length > 5);
      
      return blocks.map((block, idx) => {
        const lines = block.split('\n').map(l => l.trim()).filter(l => l);
        
        let question = lines[0].replace(/^\d+[\.\)\-]\s*/, ""); 
        let choices = { A:"", B:"", C:"", D:"" };
        let ansKey = "";
        let rationale = "";

        lines.forEach(l => {
          if(l.match(/^(Ans|Answer|Key)[\s:.-]*([A-D])/i)) {
             ansKey = l.match(/^(Ans|Answer|Key)[\s:.-]*([A-D])/i)[2].toUpperCase();
          }
          else if(l.match(/^(Rat|Rationale)[\s:.-]*/i)) {
             rationale = l.replace(/^(Rat|Rationale)[\s:.-]*/i, "");
          }
          else if(l.match(/^A[\)\.]\s*/)) choices.A = l.replace(/^A[\)\.]\s*/, "");
          else if(l.match(/^B[\)\.]\s*/)) choices.B = l.replace(/^B[\)\.]\s*/, "");
          else if(l.match(/^C[\)\.]\s*/)) choices.C = l.replace(/^C[\)\.]\s*/, "");
          else if(l.match(/^D[\)\.]\s*/)) choices.D = l.replace(/^D[\)\.]\s*/, "");
        });

        const missing = [];
        if(!question) missing.push("Question");
        if(!choices.A || !choices.B) missing.push("Choices");
        if(!ansKey) missing.push("Answer Key");

        let finalOpts = [choices.A, choices.B, choices.C, choices.D].filter(x => x);
        let correctTxt = choices[ansKey] || "";
        let finalKey = ansKey;

        if(missing.length === 0 && correctTxt) {
            finalOpts = shuffleArray(finalOpts);
            const newIdx = finalOpts.indexOf(correctTxt);
            finalKey = ["A","B","C","D"][newIdx];
        }

        return {
           id: idx,
           question: cleanStr(question),
           options: finalOpts.map(cleanStr),
           correct: cleanStr(correctTxt),
           originalKey: ansKey,
           finalKey: finalKey,
           rationale: cleanStr(rationale),
           category: detectCategory(block),
           isValid: missing.length === 0,
           missing: missing
        };
      });
    }

    // --- EVENT LISTENERS ---

    // 1. SCAN
    els.btnScan.addEventListener("click", () => {
        const raw = els.raw.value;
        if(!raw) { setStatus("Paste text first.", "error"); return; }
        
        parsedItems = parseText(raw);
        els.previewSection.style.display = "block";
        
        let validCount = 0;
        let html = "";
        
        parsedItems.forEach((p, i) => {
            if(p.isValid) validCount++;
            const statusClass = p.isValid ? "" : "invalid";
            const badgeClass = p.category === "Numerical" ? "b-num" : p.category === "Verbal" ? "b-verb" : "b-gen";
            
            html += `
            <div class="preview-card ${statusClass}">
               ${!p.isValid ? `<span class="err-txt">MISSING: ${p.missing.join(", ")}</span>` : ""}
               <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                  <span class="badge ${badgeClass}">${p.category}</span>
                  <span style="color:#64748b">Detected Ans: <b>${p.originalKey}</b> &rarr; New: <b>${p.finalKey}</b></span>
               </div>
               <div style="font-weight:600; color:#e2e8f0; margin-bottom:8px;">${i+1}. ${escapeHtml(p.question)}</div>
               <div style="font-size:13px; color:#94a3b8; padding-left:10px; border-left:2px solid #334155;">
                  ${p.options.map((o, idx) => `<div>${["A","B","C","D"][idx]}. ${escapeHtml(o)}</div>`).join("")}
               </div>
            </div>`;
        });
        
        els.previewList.innerHTML = html;
        
        if(validCount > 0) {
            els.btnUpload.disabled = false;
            els.btnUpload.innerHTML = `<i class='bx bx-cloud-upload'></i> Upload ${validCount} Valid Items`;
            setStatus(`Scanned <b>${parsedItems.length}</b> items. <b>${validCount}</b> are valid. Ready to upload.`, "success");
        } else {
            els.btnUpload.disabled = true;
            setStatus("No valid questions found. Check formatting.", "error");
        }
    });

    // 2. UPLOAD (STRICT DUPLICATION CHECK)
    els.btnUpload.addEventListener("click", async () => {
        const valid = parsedItems.filter(p => p.isValid);
        if(valid.length === 0) return;

        els.btnUpload.disabled = true;
        
        let success = 0;
        let skipped = 0;
        let errors = 0;

        for(let i=0; i<valid.length; i++) {
            const item = valid[i];
            setStatus(`Processing ${i+1}/${valid.length}: Checking duplicates...`, "process");

            try {
                // A. Check Duplicate
                const qCheck = query(
                    collection(db, "questions"), 
                    where("question", "==", item.question), 
                    limit(1)
                );
                const snap = await getDocs(qCheck);

                if(!snap.empty) {
                    skipped++;
                    continue; // SKIP
                }

                // B. Upload
                await addDoc(collection(db, "questions"), {
                    question: item.question,
                    options: item.options,
                    correct: item.correct,
                    rationale: item.rationale,
                    category: item.category,
                    timestamp: Date.now() // SAVES TIME
                });
                success++;

            } catch(e) {
                console.error(e);
                errors++;
                if(e.code === "permission-denied") {
                    alert("FIREBASE ERROR: Permission Denied. Check Firestore Rules.");
                    setStatus("Upload stopped due to permissions.", "error");
                    els.btnUpload.disabled = false;
                    return;
                }
            }
        }

        setStatus(`<b>Complete!</b> Uploaded: <b style="color:#10b981">${success}</b> | Skipped (Dupes): <b style="color:#fbbf24">${skipped}</b> | Errors: ${errors}`, "success");
        els.btnUpload.textContent = "Upload Finished";
        
        setTimeout(() => {
            els.raw.value = "";
            els.previewSection.style.display = "none";
            loadDatabase();
        }, 2000);
    });

    // 3. REFRESH & LOAD DB
    els.btnRefresh.addEventListener("click", loadDatabase);
    
    // 4. CLEAR
    els.btnClear.addEventListener("click", () => {
        els.raw.value = "";
        els.previewSection.style.display = "none";
        setStatus("Cleared.", "normal");
    });

    // 5. SEARCH
    els.searchDB.addEventListener("input", (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allDBData.filter(d => 
            d.question.toLowerCase().includes(term) || 
            d.category.toLowerCase().includes(term)
        );
        renderTable(filtered);
    });

    // 6. EXPORT
    els.btnExport.addEventListener("click", () => {
        if(allDBData.length === 0) { alert("No data to export."); return; }
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allDBData));
        const dlAnchor = document.createElement('a');
        dlAnchor.setAttribute("href", dataStr);
        dlAnchor.setAttribute("download", "cse_backup_" + Date.now() + ".json");
        document.body.appendChild(dlAnchor);
        dlAnchor.click();
        dlAnchor.remove();
    });

    // --- CORE DATABASE LOADER ---
    async function loadDatabase() {
        els.dbBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">Loading Data...</td></tr>`;
        
        try {
            const q = query(collection(db, "questions"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            
            allDBData = [];
            const stats = { total:0, num:0, verb:0, ana:0, gen:0, cler:0 };

            snapshot.forEach(doc => {
                const d = doc.data();
                d.id = doc.id;
                allDBData.push(d);

                stats.total++;
                const c = (d.category || "").toLowerCase();
                if(c.includes("num")) stats.num++;
                else if(c.includes("verb")) stats.verb++;
                else if(c.includes("ana")) stats.ana++;
                else if(c.includes("gen")) stats.gen++;
                else if(c.includes("cler")) stats.cler++;
            });

            els.sTotal.innerText = stats.total;
            els.sNum.innerText = stats.num;
            els.sVerb.innerText = stats.verb;
            els.sAna.innerText = stats.ana;
            els.sGen.innerText = stats.gen;
            els.sCler.innerText = stats.cler;

            renderTable(allDBData);
            setStatus(`Database loaded. Total items: ${stats.total}`, "normal");

        } catch(e) {
            console.error(e);
            els.dbBody.innerHTML = `<tr><td colspan="5" style="color:#ef4444; text-align:center;">Error loading data. Check Console.</td></tr>`;
        }
    }

    function renderTable(data) {
        if(data.length === 0) {
            els.dbBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">No questions found.</td></tr>`;
            return;
        }

        const displayData = data.slice(0, 100);
        
        els.dbBody.innerHTML = displayData.map(d => `
            <tr id="row-${d.id}">
                <td>
                    <div style="font-weight:600; color:#e2e8f0;">${escapeHtml(d.question)}</div>
                </td>
                <td style="color:#10b981; font-weight:bold;">${escapeHtml(d.correct)}</td>
                <td><span class="badge" style="background:#334155; color:#94a3b8;">${d.category}</span></td>
                <td style="font-size:12px; color:#fbbf24;">${formatDate(d.timestamp)}</td>
                <td>
                   <button onclick="window.delItem('${d.id}')" style="background:#ef4444; color:white; padding:5px 10px; font-size:11px;">
                     <i class='bx bx-trash'></i>
                   </button>
                </td>
            </tr>
        `).join("");
    }

    window.delItem = async (id) => {
        if(!confirm("Are you sure you want to delete this question?")) return;
        try {
            await deleteDoc(doc(db, "questions", id));
            document.getElementById(`row-${id}`).style.opacity = "0.3";
            setStatus("Deleted item.", "normal");
        } catch(e) { alert("Delete failed: " + e.message); }
    };

    // Initial Load
    loadDatabase();

  </script>
</body>
</html>
